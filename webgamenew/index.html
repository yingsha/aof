<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age of Fable - 2026 Remaster</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Menu Screen -->
        <div v-if="gameState === 'MENU'" class="container mt-5 text-center">
            <h1 class="display-4 mb-4">Age of Fable</h1>
            <p class="lead mb-5">A browser-based adventure game remastered for 2026.</p>
            
            <div class="d-grid gap-3 col-md-6 mx-auto">
                <button class="btn btn-primary btn-lg" @click="showPreGenerated">{{ t('Loc_PreGenChar') }}</button>
                <button class="btn btn-secondary btn-lg" @click="createRandomCharacter">{{ t('Loc_RandomCharacter') }}</button>
                <button v-if="hasSave" class="btn btn-success btn-lg" @click="loadGame">Continue Game</button>
            </div>
            
            <div class="mt-4">
                <button class="btn btn-sm btn-outline-secondary me-2" @click="setLang('en')">English</button>
                <button class="btn btn-sm btn-outline-secondary" @click="setLang('zh')">‰∏≠Êñá</button>
            </div>
            <div class="mt-3">
                <a href="editor.html" class="btn btn-link">Game Editor</a>
            </div>
        </div>

        <!-- Class Selection -->
        <div v-if="gameState === 'SELECT_CLASS'" class="container mt-4">
            <h2 class="mb-4 text-center">{{ t('Loc_PreGenChar') }}</h2>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                <div class="col" v-for="cls in classes" :key="cls.id">
                    <div class="card h-100 class-card" @click="selectClass(cls)">
                        <img :src="'https://aof.guzh.me/images/misc/thumb_' + cls.image + '.jpg'" class="card-img-top mx-auto" style="max-width: 80px;" alt="...">
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ cls.display_name }}</h5>
                            <p class="card-text small">{{ cls.name }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-secondary" @click="gameState = 'MENU'">{{ t('Loc_BackToMainPage') }}</button>
            </div>
        </div>

        <!-- Confirm Character -->
        <div v-if="gameState === 'CONFIRM_CHAR'" class="container mt-4">
            <div class="row">
                <div class="col-md-4 text-center">
                    <img :src="'https://aof.guzh.me/images/misc/thumb_' + currentClass.image + '.jpg'" class="img-fluid mb-3 rounded">
                    <div class="mb-3">
                        <input type="text" class="form-control text-center fw-bold fs-4" v-model="currentCharacter.name">
                    </div>
                    <p class="text-muted">{{ currentClass.display_name }}</p>
                </div>
                <div class="col-md-8">
                    <h4>Attributes</h4>
                    <ul class="list-group mb-4">
                        <li class="list-group-item d-flex justify-content-between align-items-center py-1" v-for="(val, idx) in currentCharacter.stats" :key="idx">
                            <span>{{ attributes[idx] }}</span>
                            <div class="input-group input-group-sm" style="width: 140px;">
                                <button class="btn btn-outline-secondary" @click="updateStat(idx, -1)">-</button>
                                <input type="number" class="form-control text-center" v-model.number="currentCharacter.stats[idx]">
                                <button class="btn btn-outline-secondary" @click="updateStat(idx, 1)">+</button>
                            </div>
                        </li>
                    </ul>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" @click="startGameplay">{{ t('Loc_StartPlayingWithThisCharacter') }}</button>
                        <div class="d-flex gap-2">
                            <button class="btn btn-warning flex-grow-1" @click="randomizeStats">{{ t('Loc_RandomTheirScores') }}</button>
                            <button class="btn btn-info flex-grow-1" @click="changeRandomClass">Random Class</button>
                        </div>
                        <button class="btn btn-secondary" @click="gameState = 'SELECT_CLASS'">Back</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gameplay -->
        <div v-if="gameState === 'PLAYING'" class="container-fluid h-100">
            <div class="row h-100">
                <!-- Sidebar (Stats) -->
                <div class="col-md-3 bg-light border-end p-3 d-flex flex-column" style="height: 100vh; overflow-y: auto;">
                    <div class="text-center mb-3">
                        <img v-if="currentClass" :src="'https://aof.guzh.me/images/misc/thumb_' + currentClass.image + '.jpg'" class="rounded-circle" style="width: 60px;">
                        <h5 class="mt-2">{{ currentCharacter.name }}</h5>
                    </div>
                    
                    <div class="mb-3">
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item d-flex justify-content-between p-1 bg-transparent" v-for="(val, idx) in currentCharacter.stats" :key="idx">
                                <span>{{ attributes[idx] }}</span>
                                <strong>{{ val }}</strong>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mt-auto">
                        <div class="p-2 text-center border-top bg-light">
                            <strong>{{ t('Loc_CowrieShells') || 'Shells:' }} {{ currentCharacter.money }}</strong>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary w-100 mb-2" @click="saveGame">Save Game</button>
                        <button class="btn btn-sm btn-outline-danger w-100" @click="gameState = 'MENU'">Exit to Menu</button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-6 p-4 d-flex flex-column" style="height: 100vh; overflow-y: auto;">
                    <div v-if="currentEvent">
                        <!-- Image if any (logic needed to extract image from text or separate field) -->
                        
                        <div class="game-text mb-4 fs-5" v-html="accumulatedText"></div>
                        
                        <!-- Continue Button for Type 13 -->
                        <div v-if="currentEvent && currentEvent.logic && currentEvent.logic.type === 'click_continue'" class="text-center mb-4">
                            <button class="btn btn-primary btn-lg" @click="goToEvent(currentEvent.logic.next, true)">{{ t('Loc_Continue') }}</button>
                        </div>

                        <div class="game-actions">
                            <div class="list-group">
                                <button v-for="(choice, idx) in availableChoices" :key="idx"
                                        class="list-group-item list-group-item-action py-3"
                                        @click="goToEvent(choice.next_event, true)">
                                    {{ t(choice.text_key) || choice.text }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-center mt-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading Event...</p>
                    </div>
                </div>

                <!-- Right Panel (Log/Inventory) -->
                <div class="col-md-3 bg-light border-start p-3" style="height: 100vh; overflow-y: auto;">
                    <h6 class="border-bottom pb-2">Game Log</h6>
                    <div class="small text-muted mb-4">
                        <div v-for="(log, i) in gameLogs" :key="i" class="mb-1">{{ log }}</div>
                    </div>
                    
                    <h6 class="border-bottom pb-2">Inventory</h6>
                    <div class="small">
                        <span v-if="currentCharacter.inventory.length === 0" class="text-muted">Empty</span>
                        <ul v-else class="list-unstyled">
                            <li v-for="item in currentCharacter.inventory" :key="item">{{ getItemName(item) }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Toggle Button (Fixed) -->
        <button class="btn btn-warning position-fixed bottom-0 end-0 m-3 shadow" style="z-index: 1050; border-radius: 50px; width: 60px; height: 60px; opacity: 0.8;" @click="debugToggle" title="Debug">
            üõ†Ô∏è
        </button>

        <!-- Debug UI Panel (Fixed) -->
        <div v-if="debugMode" class="card position-fixed bottom-0 end-0 m-3 p-3 shadow border-warning" style="width: 350px; height: 600px; overflow-y: auto; z-index: 1040; margin-bottom: 80px !important;">
            <h5 class="text-warning">Debug Console</h5>
            
            <!-- Jump -->
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Event ID" v-model="debugJumpId">
                <button class="btn btn-primary" @click="debugJump">Jump</button>
            </div>

            <!-- Shells -->
            <div class="mb-3">
                <h6 class="border-bottom">Shells: {{ currentCharacter.money }}</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success" @click="debugAddShells(10)">+10</button>
                    <button class="btn btn-outline-success" @click="debugAddShells(100)">+100</button>
                    <button class="btn btn-outline-danger" @click="debugAddShells(-10)">-10</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="mb-3">
                <h6 class="border-bottom">Attributes</h6>
                <div class="row g-1">
                    <div class="col-6" v-for="(val, idx) in currentCharacter.stats" :key="idx">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text small" style="width: 80px; overflow: hidden;">{{ attributes[idx] }}</span>
                            <input type="number" class="form-control" v-model.number="currentCharacter.stats[idx]">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items -->
            <div class="mb-3">
                <h6 class="border-bottom">Items</h6>
                <div class="input-group input-group-sm mb-2">
                    <select class="form-select" v-model="debugAddItemSelect">
                        <option v-for="i in items" :value="i.id">{{ i.name }}</option>
                    </select>
                    <button class="btn btn-success" @click="debugAddItem">Add</button>
                </div>
                <ul class="list-group list-group-flush small" style="max-height: 100px; overflow-y: auto;">
                    <li v-for="id in currentCharacter.inventory" :key="id" class="list-group-item d-flex justify-content-between p-1 align-items-center">
                        {{ getItemName(id) }}
                        <button class="btn btn-sm btn-outline-danger py-0 px-1" @click="debugRemoveItem(id)">x</button>
                    </li>
                </ul>
            </div>

            <!-- Keywords -->
            <div class="mb-3">
                <h6 class="border-bottom">Keywords</h6>
                <div class="input-group input-group-sm mb-2">
                    <select class="form-select" v-model="debugAddKwSelect">
                        <option v-for="k in keywordsData" :value="k.id">{{ k.id }}: {{ k.name.substring(0,15) }}...</option>
                    </select>
                    <button class="btn btn-success" @click="debugAddKeyword">Add</button>
                </div>
                <ul class="list-group list-group-flush small" style="max-height: 100px; overflow-y: auto;">
                    <li v-for="id in currentCharacter.keywords" :key="id" class="list-group-item d-flex justify-content-between p-1 align-items-center">
                        <span class="text-truncate" style="max-width: 200px;">{{ getKwName(id) }}</span>
                        <button class="btn btn-sm btn-outline-danger py-0 px-1" @click="debugRemoveKeyword(id)">x</button>
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="data/attributes.js"></script>
    <script src="data/classes.js"></script>
    <script src="data/localization.js"></script>
    <script src="data/events.js"></script>
    <script src="data/items.js"></script>
    <script src="data/keywords.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
