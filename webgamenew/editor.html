<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age of Fable - Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .nav-tabs .nav-link.active { font-weight: bold; }
        .edit-row:hover { background-color: #f1f1f1; cursor: pointer; }
    </style>
</head>
<body>
    <div id="app" class="container mt-4">
        <header class="mb-4 d-flex justify-content-between align-items-center">
            <h1>Game Data Editor</h1>
            <div>
                <a href="index.html" class="btn btn-outline-secondary me-2">Back to Game</a>
                <button class="btn btn-success" @click="downloadAll">Download All JSONs</button>
            </div>
        </header>

        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><a class="nav-link" :class="{active: activeTab === 'classes'}" @click="activeTab = 'classes'" href="#">Classes</a></li>
            <li class="nav-item"><a class="nav-link" :class="{active: activeTab === 'events'}" @click="activeTab = 'events'" href="#">Events (Story)</a></li>
            <li class="nav-item"><a class="nav-link" :class="{active: activeTab === 'localization'}" @click="activeTab = 'localization'" href="#">Localization</a></li>
        </ul>

        <!-- Classes Tab -->
        <div v-if="activeTab === 'classes'">
            <div class="mb-3 text-end">
                <button class="btn btn-primary btn-sm" @click="addClass">Add New Class</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Stats (Sum)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="cls in classes" :key="cls.id" @click="editClass(cls)" class="edit-row">
                            <td>{{ cls.id }}</td>
                            <td><img :src="'https://aof.guzh.me/images/misc/thumb_' + cls.image + '.jpg'" style="height: 30px;"> {{ cls.image }}</td>
                            <td>{{ cls.display_name }}</td>
                            <td>{{ cls.stats.reduce((a,b)=>a+b, 0) }}</td>
                            <td><button class="btn btn-danger btn-sm" @click.stop="deleteClass(cls)">Delete</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Events Tab -->
        <div v-if="activeTab === 'events'">
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" v-model="eventSearch" placeholder="Search events by ID or text...">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" @click="addEvent">Add New Event</button>
                </div>
            </div>
            <div class="list-group">
                <div v-for="evt in filteredEvents" :key="evt.id" class="list-group-item list-group-item-action" @click="editEvent(evt)">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">{{ evt.id }}</h5>
                        <small>{{ evt.options.length }} options</small>
                    </div>
                    <p class="mb-1 text-truncate">{{ evt.text_zh }}</p>
                    <small class="text-muted">{{ evt.text_en }}</small>
                </div>
            </div>
        </div>

        <!-- Localization Tab -->
        <div v-if="activeTab === 'localization'">
            <div class="row mb-3">
                <div class="col">
                    <input type="text" class="form-control" v-model="locSearch" placeholder="Search keys or text...">
                </div>
                <div class="col-auto">
                    <input type="file" ref="csvInput" @change="importCSV" style="display:none" accept=".csv">
                    <button class="btn btn-info me-2" @click="$refs.csvInput.click()">Import CSV</button>
                    <button class="btn btn-secondary me-2" @click="exportCSV">Export CSV</button>
                    <button class="btn btn-primary" @click="addLocKey">Add Key</button>
                </div>
            </div>
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>English</th>
                            <th>Chinese</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(val, key) in filteredLoc" :key="key">
                            <td><input type="text" class="form-control form-control-sm" :value="key" readonly></td>
                            <td><input type="text" class="form-control form-control-sm" v-model="localization[key].en"></td>
                            <td><input type="text" class="form-control form-control-sm" v-model="localization[key].zh"></td>
                            <td><button class="btn btn-danger btn-sm" @click="deleteLoc(key)">X</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modals -->
        <!-- Class Edit Modal -->
        <div v-if="editingClass" class="modal d-block" style="background: rgba(0,0,0,0.5)">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Class</h5>
                        <button type="button" class="btn-close" @click="editingClass = null"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-2">
                            <div class="col">
                                <label>ID (Number)</label>
                                <input type="number" class="form-control" v-model.number="editingClass.id">
                            </div>
                            <div class="col">
                                <label>Display Name</label>
                                <input type="text" class="form-control" v-model="editingClass.display_name">
                            </div>
                        </div>
                        <div class="mb-2">
                             <label>Image Name (e.g. talking-cat)</label>
                             <input type="text" class="form-control" v-model="editingClass.image">
                        </div>
                        <div class="row">
                            <div class="col-3 mb-2" v-for="(attr, idx) in attributes" :key="idx">
                                <label class="small">{{ attr }}</label>
                                <input type="number" class="form-control form-control-sm" v-model.number="editingClass.stats[idx]">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="editingClass = null">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Edit Modal -->
        <div v-if="editingEvent" class="modal d-block" style="background: rgba(0,0,0,0.5)">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Event</h5>
                        <button type="button" class="btn-close" @click="editingEvent = null"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label>Event ID</label>
                            <input type="text" class="form-control" v-model="editingEvent.id">
                        </div>
                        <div class="mb-2">
                            <label>Description (ZH)</label>
                            <textarea class="form-control" v-model="editingEvent.text_zh" rows="2"></textarea>
                        </div>
                        <div class="mb-2">
                            <label>Description (EN)</label>
                            <textarea class="form-control" v-model="editingEvent.text_en" rows="2"></textarea>
                        </div>
                        <hr>
                        <h6>Options <button class="btn btn-sm btn-outline-primary" @click="addOption(editingEvent)">+</button></h6>
                        <div v-for="(opt, idx) in editingEvent.options" :key="idx" class="border p-2 mb-2 rounded bg-light">
                            <div class="row mb-1">
                                <div class="col"><input type="text" class="form-control form-control-sm" v-model="opt.text_zh" placeholder="Option Text (ZH)"></div>
                                <div class="col"><input type="text" class="form-control form-control-sm" v-model="opt.text_en" placeholder="Option Text (EN)"></div>
                            </div>
                            <div class="row">
                                <div class="col"><input type="text" class="form-control form-control-sm" v-model="opt.next_event" placeholder="Next Event ID"></div>
                                <div class="col-auto"><button class="btn btn-sm btn-danger" @click="editingEvent.options.splice(idx, 1)">X</button></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                         <button class="btn btn-danger me-auto" @click="deleteEvent(editingEvent)">Delete Event</button>
                        <button class="btn btn-secondary" @click="editingEvent = null">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- 加载数据脚本 -->
    <script src="data/attributes.js"></script>
    <script src="data/classes.js"></script>
    <script src="data/localization.js"></script>
    <script src="data/events.js"></script>

    <script src="js/editor.js"></script>
</body>
</html>
